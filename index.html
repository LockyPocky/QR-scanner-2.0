<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR сканер позиции и участника</title>
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<style>
  body { font-family: Arial; text-align: center; padding: 10px; }
  #reader { width: 100%; max-width: 400px; margin: 10px auto; }
  .info { margin-top: 10px; font-size: 16px; }
  #result { margin-top: 10px; color: green; }
  button { font-size: 16px; padding: 10px 15px; margin-top: 10px; cursor: pointer; }
</style>
</head>
<body>

<h2>Сканирование QR позиции и участника</h2>
<p>Сначала сканируем QR позиции (ячейка), потом QR участника (ID)</p>

<button id="startBtn">Начать сканирование</button>

<div id="reader"></div>
<div class="info">Целевая ячейка: <span id="targetCell"></span></div>
<div class="info">ID участника: <span id="participantId"></span></div>
<button id="downloadBtn">Скачать CSV</button>
<div id="result"></div>

<script>
let html5QrCode = null;
let targetCell = null;
let participantId = null;
let data = [];

// Обработчик кнопки "Начать сканирование"
document.getElementById("startBtn").addEventListener("click", () => {
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" }, // задняя камера
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      if (!targetCell) {
        targetCell = qrCodeMessage;
        document.getElementById("targetCell").innerText = targetCell;
      } else if (!participantId) {
        participantId = qrCodeMessage;
        document.getElementById("participantId").innerText = participantId;

        // Сохраняем данные
        data.push({ cell: targetCell, participant: participantId });
        document.getElementById("result").innerText = `Сохранено: ${targetCell} → ${participantId}`;

        // Сброс для следующего сканирования
        targetCell = null;
        participantId = null;
        document.getElementById("targetCell").innerText = "";
        document.getElementById("participantId").innerText = "";
      }
    },
    errorMessage => { console.log("QR ошибка:", errorMessage); }
  ).catch(err => {
    alert("Ошибка запуска камеры: " + err);
  });
});

// Кнопка для скачивания CSV
document.getElementById("downloadBtn").addEventListener("click", () => {
  if (data.length === 0) { alert("Нет данных для экспорта"); return; }
  let csvContent = "data:text/csv;charset=utf-8,Cell,Participant\n";
  data.forEach(item => {
    csvContent += `${item.cell},${item.participant}\n`;
  });
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "scan_results.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
</script>

</body>
</html>